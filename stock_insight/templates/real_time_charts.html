<!-- real_time_charts.html -->
{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto mt-8 flex">
    <!-- Main Chart Area -->
    <div class="flex-grow">
        <div id="stock-info" class="text-3xl font-bold text-center text-blue-800 mb-4">
            <!-- Stock name, price, and percentage change will be inserted here -->
        </div>
        <div id="chart-data" style="height: 500px; min-width: 310px"></div>
    </div>

    <!-- Sidebar for Stock List with Search Functionality -->
    <div class="w-1/4 ml-4 p-4 bg-gray-100 rounded-lg shadow-lg">
        <h2 class="text-xl font-semibold mb-4">Search Stock</h2>
        <input type="text" id="stock-search" class="w-full p-2 border rounded mb-4" placeholder="Search for a stock...">

        <div id="stock-list-container" class="h-96 overflow-y-scroll">
            {% include 'stock_list.html' %}
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        function fetchStockData(symbol) {
            $.get(`/fetch-historical-data/${symbol}/`, function (data) {
                console.log('API Response:', data);

                if (data.error) {
                    $('#chart-data').html('<p>Error: ' + data.error + '</p>');
                    return;
                }

                if (!data.data || data.data.candles.length === 0) {
                    $('#chart-data').html('<p>No data available for ' + symbol + '</p>');
                    return;
                }

                var chartData = data.data.candles.map(candle => {
                    return [
                        candle[0],  // Timestamp in milliseconds
                        candle[1],  // Open
                        candle[2],  // High
                        candle[3],  // Low
                        candle[4]   // Close
                    ];
                });

                // Keep the data in chronological order (left to right)
                chartData.reverse();

                console.log('Processed Chart Data:', chartData);

                // Latest price is the last entry in the array (right side of the chart)
                var latestClose = chartData[chartData.length - 1][4];
                
                // Find the last day's close price
                var lastDayCloseIndex = chartData.length - 2; // Index of the previous day's close
                var lastDayClose = chartData[lastDayCloseIndex][4];

                // Calculate the percentage change based on last day's close and the latest close
                var percentageChange = ((latestClose - lastDayClose) / lastDayClose * 100).toFixed(2);

                // Update the stock info heading
                $('#stock-info').html(`${symbol} - $${latestClose} (${percentageChange}%)`);

                Highcharts.stockChart('chart-data', {
                    chart: {
                        marginRight: 50 // Adds margin to the right of the chart
                    },
                    yAxis: {
                        labels: {
                            align: 'left', // Aligns the price labels to the left of the yAxis
                            x: 15 // Adds extra space between the price labels and the yAxis
                        }
                    },
                    rangeSelector: {
                        buttons: [{
                            type: 'minute',
                            count: 30,
                            text: '30m'
                        }, {
                            type: 'hour',
                            count: 1,
                            text: '1h'
                        }, {
                            type: 'day',
                            count: 1,
                            text: '1D'
                        }, {
                            type: 'all',
                            count: 1,
                            text: 'All'
                        }],
                        selected: 1,
                        inputEnabled: false
                    },
                    series: [{
                        name: symbol,
                        type: 'candlestick',
                        data: chartData,
                        tooltip: {
                            valueDecimals: 2
                        }
                    }]
                });
            }).fail(function (jqXHR, textStatus, errorThrown) {
                $('#chart-data').html('<p>Failed to fetch data: ' + textStatus + '</p>');
            });
        }

        // Fetch data for the initially selected stock
        fetchStockData($('.stock-item:first').data('symbol'));

        // Handle stock selection from the list
        $('.stock-item').click(function () {
            fetchStockData($(this).data('symbol'));
        });

        // Implement search functionality
        $('#stock-search').on('keyup', function () {
            var searchTerm = $(this).val().toLowerCase();
            $('.stock-item').each(function () {
                var stockName = $(this).text().toLowerCase();
                if (stockName.indexOf(searchTerm) !== -1) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });
    });
</script>
{% endblock content %}
