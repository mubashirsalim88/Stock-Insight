<!-- real_time_charts.html -->
{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto mt-8 flex">
    <!-- Main Chart Area -->
    <div class="flex-grow">
        <div id="stock-info" class="text-3xl font-bold text-center text-blue-800 mb-4">
            <!-- Stock name, price, and percentage change will be inserted here -->
        </div>
        <div id="chart-data" style="height: 500px; min-width: 310px"></div>
    </div>

    <!-- Sidebar for Stock List with Search Functionality -->
    <div class="w-1/4 ml-4 p-4 bg-gray-100 rounded-lg shadow-lg">
        <h2 class="text-xl font-semibold mb-4">Search Stock</h2>
        <input type="text" id="stock-search" class="w-full p-2 border rounded mb-4" placeholder="Search for a stock...">

        <div id="stock-list-container" class="h-96 overflow-y-scroll">
            {% include 'stock_list.html' %}
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        function fetchStockData(symbol, timeframe = '30minute') {
            $.get(`/fetch-historical-data/${symbol}/`, function (data) {
                console.log('API Response:', data);

                if (data.error) {
                    $('#chart-data').html('<p>Error: ' + data.error + '</p>');
                    return;
                }

                // Select the appropriate data based on the timeframe
                var chartData = [];
                if (timeframe === '30minute' && data['30minute'].data && data['30minute'].data.candles.length > 0) {
                    chartData = data['30minute'].data.candles.map(candle => [
                        candle[0],  // Timestamp in milliseconds
                        candle[1],  // Open
                        candle[2],  // High
                        candle[3],  // Low
                        candle[4]   // Close
                    ]).reverse();
                } else if (timeframe === 'day' && data['day'].data && data['day'].data.candles.length > 0) {
                    chartData = data['day'].data.candles.map(candle => [
                        candle[0],  // Timestamp in milliseconds
                        candle[1],  // Open
                        candle[2],  // High
                        candle[3],  // Low
                        candle[4]   // Close
                    ]).reverse();
                } else {
                    $('#chart-data').html('<p>No data available for ' + symbol + '</p>');
                    return;
                }

                // Update the stock info heading with the latest close price
                var latestClose = chartData[chartData.length - 1][4];
                var lastDayCloseIndex = chartData.length - 2;
                var lastDayClose = chartData[lastDayCloseIndex][4];
                var percentageChange = ((latestClose - lastDayClose) / lastDayClose * 100).toFixed(2);
                $('#stock-info').html(`${symbol} - $${latestClose} (${percentageChange}%)`);

                // Render the chart with the selected timeframe data
                Highcharts.stockChart('chart-data', {
                    chart: {
                        marginRight: 50
                    },
                    yAxis: {
                        labels: {
                            align: 'left',
                            x: 15
                        }
                    },
                    rangeSelector: {
                        allButtonsEnabled: true,
                        buttons: [{
                            type: 'minute',
                            count: 30,
                            text: '30m',
                            events: {
                                click: function () {
                                    fetchStockData(symbol, '30minute');
                                }
                            }
                        }, {
                            type: 'day',
                            count: 1,
                            text: '1D',
                            events: {
                                click: function () {
                                    fetchStockData(symbol, 'day');
                                }
                            }
                        }],
                        selected: timeframe === '30minute' ? 0 : 1,
                        inputEnabled: false
                    },
                    series: [{
                        name: symbol,
                        type: 'candlestick',
                        data: chartData,
                        tooltip: {
                            valueDecimals: 2
                        }
                    }]
                });
            }).fail(function (jqXHR, textStatus, errorThrown) {
                $('#chart-data').html('<p>Failed to fetch data: ' + textStatus + '</p>');
            });
        }

        // Fetch data for the initially selected stock with default timeframe 30 minutes
        fetchStockData($('.stock-item:first').data('symbol'), '30minute');

        // Handle stock selection from the list
        $('.stock-item').click(function () {
            fetchStockData($(this).data('symbol'), '30minute');
        });

        // Implement search functionality
        $('#stock-search').on('keyup', function () {
            var searchTerm = $(this).val().toLowerCase();
            $('.stock-item').each(function () {
                var stockName = $(this).text().toLowerCase();
                if (stockName.indexOf(searchTerm) !== -1) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });
    });
</script>


{% endblock content %}
