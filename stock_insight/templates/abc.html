{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto mt-8 flex">
    <!-- Main Chart Area -->
    <div class="flex-grow">
        <div id="stock-info" class="text-3xl font-bold text-center text-blue-800 mb-4">
            <!-- Stock name, price, and percentage change will be inserted here -->
        </div>
        <div id="chart-data" style="height: 500px; min-width: 310px"></div>
    </div>

    <!-- Sidebar for Stock List with Search Functionality -->
    <div class="w-1/4 ml-4 p-4 bg-gray-100 rounded-lg shadow-lg">
        <h2 class="text-xl font-semibold mb-4">Search Stock</h2>
        <input type="text" id="stock-search" class="w-full p-2 border rounded mb-4" placeholder="Search for a stock...">

        <div id="stock-list-container" class="h-96 overflow-y-scroll">
            {% include 'stock_list.html' %}
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        const accessToken = "{{ access_token }}";

        function fetchLTP(symbol) {
            const apiUrl = `https://api-v2.upstox.com/v2/market-quote/ltp?symbol=${symbol}`;
            
            return $.ajax({
                url: apiUrl,
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'accept': 'application/json'
                }
            });
        }

        function fetchStockData(symbol, timeframe = 'day') {
            $.get(`/fetch-historical-data/${symbol}/`, function (data) {
                console.log('API Response:', data);

                if (data.error) {
                    $('#chart-data').html('<p>Error: ' + data.error + '</p>');
                    return;
                }

                // Fetch LTP and update stock info
                fetchLTP(symbol).done(function(ltpData) {
                    const ltp = ltpData.data[symbol].ltp;
                    $('#stock-info').html(`${symbol} - LTP: ₹${ltp}`);
                }).fail(function() {
                    $('#stock-info').html(`${symbol} - LTP: N/A`);
                });

                // Process chart data
                var chartData = [];

                if (timeframe === '30minute' && data['30minute'].data && data['30minute'].data.candles.length > 0) {
                    chartData = data['30minute'].data.candles.map(candle => [
                        candle[0],  // Timestamp in milliseconds
                        candle[1],  // Open
                        candle[2],  // High
                        candle[3],  // Low
                        candle[4]   // Close
                    ]).reverse();
                } else if (timeframe === 'day' && data['day'].data && data['day'].data.candles.length > 0) {
                    chartData = data['day'].data.candles.map(candle => [
                        candle[0],  // Timestamp in milliseconds
                        candle[1],  // Open
                        candle[2],  // High
                        candle[3],  // Low
                        candle[4]   // Close
                    ]).reverse();
                } else {
                    $('#chart-data').html('<p>No data available for ' + symbol + '</p>');
                    return;
                }

                Highcharts.stockChart('chart-data', {
                    chart: {
                        marginRight: 50
                    },
                    yAxis: {
                        labels: {
                            align: 'left',
                            x: 15
                        }
                    },
                    rangeSelector: {
                        allButtonsEnabled: true,
                        buttons: [{
                            type: 'minute',
                            count: 30,
                            text: '30m',
                            events: {
                                click: function () {
                                    fetchStockData(symbol, '30minute');
                                }
                            }
                        }, {
                            type: 'day',
                            count: 1,
                            text: '1D',
                            events: {
                                click: function () {
                                    fetchStockData(symbol, 'day');
                                }
                            }
                        }],
                        selected: timeframe === 'day' ? 0 : 1,
                        inputEnabled: false
                    },
                    series: [{
                        name: symbol,
                        type: 'candlestick',
                        data: chartData,
                        tooltip: {
                            valueDecimals: 2
                        }
                    }]
                });
            }).fail(function (jqXHR, textStatus, errorThrown) {
                $('#chart-data').html('<p>Failed to fetch data: ' + textStatus + '</p>');
            });
        }

        function startLTPAutoRefresh(symbol) {
            setInterval(function() {
                fetchLTP(symbol).done(function(ltpData) {
                    const ltp = ltpData.data[symbol].ltp;
                    $('#stock-info').html(`${symbol} - LTP: ₹${ltp}`);
                }).fail(function() {
                    $('#stock-info').html(`${symbol} - LTP: N/A`);
                });
            }, 5000); // Refresh every 5 seconds
        }

        // Fetch data for the initially selected stock with default timeframe day
        const initialSymbol = $('.stock-item:first').data('symbol');
        fetchStockData(initialSymbol, 'day');
        startLTPAutoRefresh(initialSymbol);

        // Handle stock selection from the list
        $('.stock-item').click(function () {
            const selectedSymbol = $(this).data('symbol');
            fetchStockData(selectedSymbol, 'day');
            startLTPAutoRefresh(selectedSymbol);
        });

        // Implement search functionality
        $('#stock-search').on('keyup', function () {
            var searchTerm = $(this).val().toLowerCase();
            $('.stock-item').each(function () {
                var stockName = $(this).text().toLowerCase();
                if (stockName.indexOf(searchTerm) !== -1) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });
    });
</script>

{% endblock content %}
